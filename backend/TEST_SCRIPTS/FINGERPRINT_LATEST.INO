#include <Adafruit_Fingerprint.h>
#include <SoftwareSerial.h>

// ---------------- Fingerprint Serial ----------------
SoftwareSerial FingerSerial(2, 3); // RX, TX
Adafruit_Fingerprint finger(&FingerSerial);

// -------- Match control flag --------
bool matchMode = false;

void setup() {
  Serial.begin(9600);
  delay(2000);

  Serial.println("\n=== FINGERPRINT SYSTEM ===");
  Serial.println("Commands:");
  Serial.println("FP_ENROLL <id>");
  Serial.println("FP_MATCH   (start continuous matching)");
  Serial.println("FP_STOP    (stop matching)");
  Serial.println("FP_CLEAR   (erase ALL fingerprints)");

  FingerSerial.begin(57600);
  finger.begin(57600);

  if (finger.verifyPassword()) {
    Serial.println("‚úÖ Fingerprint sensor detected");
  } else {
    Serial.println("‚ùå Fingerprint sensor NOT detected");
    while (1);
  }
}

void loop() {

  // -------- SERIAL COMMAND HANDLING --------
  if (Serial.available()) {
    String command = Serial.readStringUntil('\n');
    command.trim();

    if (command.startsWith("FP_ENROLL")) {
      int id = command.substring(9).toInt();

      if (id < 1 || id > 127) {
        Serial.println("‚ùå Invalid Fingerprint ID (1‚Äì127)");
        return;
      }

      Serial.print("üìù Enrolling Fingerprint ID: ");
      Serial.println(id);

      if (enrollFingerprint(id)) {
        Serial.println("üéâ Fingerprint Enrollment SUCCESS");
      } else {
        Serial.println("‚ùå Fingerprint Enrollment FAILED");
      }
    }

    else if (command.equalsIgnoreCase("FP_MATCH")) {
      matchMode = true;
      Serial.println("üîç CONTINUOUS MATCHING STARTED");
    }

    else if (command.equalsIgnoreCase("FP_STOP")) {
      matchMode = false;
      Serial.println("‚õî MATCHING STOPPED");
    }

    else if (command.equalsIgnoreCase("FP_CLEAR")) {
      clearFingerprintDatabase();
    }

    else {
      Serial.println("‚ùå Unknown command");
    }
  }

  // -------- CONTINUOUS MATCHING --------
  if (matchMode) {
    matchFingerprint();
  }
}

// ================= ENROLL FUNCTION =================
// ‚ùó UNCHANGED
bool enrollFingerprint(uint8_t id) {
  int p = -1;

  Serial.println("üëâ Place finger");
  while (p != FINGERPRINT_OK) {
    p = finger.getImage();
    delay(100);
  }

  if (finger.image2Tz(1) != FINGERPRINT_OK) return false;

  Serial.println("‚úã Remove finger");
  delay(2000);
  while (finger.getImage() != FINGERPRINT_NOFINGER);

  Serial.println("üëâ Place SAME finger again");
  p = -1;
  while (p != FINGERPRINT_OK) {
    p = finger.getImage();
    delay(100);
  }

  if (finger.image2Tz(2) != FINGERPRINT_OK) return false;

  if (finger.createModel() != FINGERPRINT_OK) {
    Serial.println("‚ùå Fingerprints did NOT match");
    return false;
  }

  if (finger.storeModel(id) != FINGERPRINT_OK) {
    Serial.println("‚ùå Failed to store fingerprint");
    return false;
  }

  return true;
}

// ================= MATCH FUNCTION =================
// ‚úÖ FP_STOP now works instantly
void matchFingerprint() {
  int p = -1;

  // Wait for finger
  while (p != FINGERPRINT_OK && matchMode) {
    p = finger.getImage();

    // üî¥ CHECK SERIAL WHILE BLOCKING
    if (Serial.available()) {
      String cmd = Serial.readStringUntil('\n');
      cmd.trim();
      if (cmd.equalsIgnoreCase("FP_STOP")) {
        matchMode = false;
        Serial.println("‚õî MATCHING STOPPED");
        return;
      }
    }

    if (p == FINGERPRINT_NOFINGER) delay(100);
  }

  if (!matchMode) return;

  if (finger.image2Tz() != FINGERPRINT_OK) return;

  p = finger.fingerSearch();
  if (p == FINGERPRINT_OK) {
    Serial.print("‚úÖ MATCH FOUND ‚Üí ID: ");
    Serial.print(finger.fingerID);
    Serial.print(" | Confidence: ");
    Serial.println(finger.confidence);
  } else {
    Serial.println("‚ùå NO MATCH FOUND");
  }

  Serial.println("‚úã Remove finger");

  while (finger.getImage() != FINGERPRINT_NOFINGER && matchMode) {

    // üî¥ CHECK SERIAL AGAIN
    if (Serial.available()) {
      String cmd = Serial.readStringUntil('\n');
      cmd.trim();
      if (cmd.equalsIgnoreCase("FP_STOP")) {
        matchMode = false;
        Serial.println("‚õî MATCHING STOPPED");
        return;
      }
    }

    delay(100);
  }
}

// ================= CLEAR DATABASE =================
void clearFingerprintDatabase() {
  Serial.println("‚ö†Ô∏è Clearing ALL fingerprint data...");
  if (finger.emptyDatabase() == FINGERPRINT_OK) {
    Serial.println("‚úÖ Fingerprint database cleared");
  } else {
    Serial.println("‚ùå Failed to clear fingerprint database");
  }
}
